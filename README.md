Based off of https://github.com/davda54/sam.